#!/bin/bash
# 악성 프로세스 및 파일 모니터링 스크립트
# 서버에 배치하여 주기적으로 실행 (cron 등)

LOG_FILE="/home/min/malware-check.log"
ALERT_EMAIL=""  # 필요시 이메일 주소 설정
DATE=$(date '+%Y-%m-%d %H:%M:%S')

# 악성 프로세스 패턴 (next-server는 정상 프로세스이므로 제외)
MALICIOUS_PATTERNS="vmlunix|VM-unix|X11-unix|javap|vmiluniz|/var/tmp/next|/tmp/.VM-unix/vmlunix"

# 악성 파일/디렉토리 패턴
MALICIOUS_PATHS=(
    "/tmp/.VM-unix"
    "/tmp/.X11-unix"
    "/var/tmp/.bin"
    "/var/tmp/next"
)

echo "[$DATE] === 악성 프로세스 및 파일 검사 시작 ===" >> "$LOG_FILE"

# 1. 악성 프로세스 검사
MALICIOUS_PROCESSES=$(ps aux | grep -E "$MALICIOUS_PATTERNS" | grep -v grep)

if [ ! -z "$MALICIOUS_PROCESSES" ]; then
    echo "[$DATE] ⚠️ ALERT: 악성 프로세스 발견!" >> "$LOG_FILE"
    echo "$MALICIOUS_PROCESSES" >> "$LOG_FILE"
    
    # 자동 종료 (선택사항 - 주석 해제하여 활성화)
    # echo "[$DATE] 악성 프로세스 자동 종료 시도..." >> "$LOG_FILE"
    # ps aux | grep -E "$MALICIOUS_PATTERNS" | grep -v grep | awk '{print $2}' | xargs sudo kill -9 2>> "$LOG_FILE"
else
    echo "[$DATE] ✅ 악성 프로세스 없음" >> "$LOG_FILE"
fi

# 2. 악성 파일/디렉토리 검사
for path in "${MALICIOUS_PATHS[@]}"; do
    if [ -e "$path" ]; then
        echo "[$DATE] ⚠️ ALERT: 의심스러운 경로 발견: $path" >> "$LOG_FILE"
        ls -la "$path" >> "$LOG_FILE" 2>&1
        
        # 자동 삭제 (선택사항 - 주석 해제하여 활성화)
        # echo "[$DATE] 의심스러운 경로 삭제 시도: $path" >> "$LOG_FILE"
        # sudo rm -rf "$path" 2>> "$LOG_FILE"
    fi
done

# 3. Docker 컨테이너 내부 검사
CONTAINERS=$(docker ps --format '{{.Names}}' 2>/dev/null)

if [ ! -z "$CONTAINERS" ]; then
    echo "[$DATE] === Docker 컨테이너 내부 검사 ===" >> "$LOG_FILE"
    
    for container in $CONTAINERS; do
        # 컨테이너 내부 악성 프로세스 검사
        # next-server는 정상 프로세스이므로 제외하고, 실제 악성 프로세스만 검사
        CONTAINER_PROCESSES=$(docker exec "$container" ps aux 2>/dev/null | grep -v grep)
        CONTAINER_MALICIOUS=$(echo "$CONTAINER_PROCESSES" | grep -E "$MALICIOUS_PATTERNS" | grep -v "next-server" | grep -v "ps aux")
        
        if [ ! -z "$CONTAINER_MALICIOUS" ]; then
            echo "[$DATE] ⚠️ ALERT: 컨테이너 $container 내부에 악성 프로세스 발견!" >> "$LOG_FILE"
            echo "$CONTAINER_MALICIOUS" >> "$LOG_FILE"
        fi
        
        # 컨테이너 내부 의심스러운 디렉토리 검사
        for path in "${MALICIOUS_PATHS[@]}"; do
            if docker exec "$container" test -e "$path" 2>/dev/null; then
                echo "[$DATE] ⚠️ ALERT: 컨테이너 $container 내부에 의심스러운 경로 발견: $path" >> "$LOG_FILE"
                docker exec "$container" ls -la "$path" >> "$LOG_FILE" 2>&1
            fi
        done
    done
else
    echo "[$DATE] 실행 중인 Docker 컨테이너 없음" >> "$LOG_FILE"
fi

# 4. CPU 사용률 확인 (과부하 감지)
CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | sed 's/%us,//')
if (( $(echo "$CPU_USAGE > 80" | bc -l) )); then
    echo "[$DATE] ⚠️ WARNING: 높은 CPU 사용률 감지: ${CPU_USAGE}%" >> "$LOG_FILE"
    top -bn1 | head -20 >> "$LOG_FILE"
fi

# 5. 의심스러운 네트워크 연결 확인 (선택사항)
# netstat -antp | grep ESTABLISHED | awk '{print $5}' | cut -d: -f1 | sort | uniq -c | sort -rn | head -10 >> "$LOG_FILE"

echo "[$DATE] === 검사 완료 ===" >> "$LOG_FILE"
echo "" >> "$LOG_FILE"

# 로그 파일 크기 제한 (최근 1000줄만 유지)
tail -n 1000 "$LOG_FILE" > "${LOG_FILE}.tmp" && mv "${LOG_FILE}.tmp" "$LOG_FILE"

